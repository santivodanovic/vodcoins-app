<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>VodCoins CSCJ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS MODERNOS (V16.0) --- */
        :root {
            --primary-color: #4a90e2;
            --accent-color: #50e3c2;
            --bg-gradient: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 8px 30px rgba(0,0,0,0.12);
        }

        body { 
            font-family: 'Poppins', sans-serif; 
            margin: 0; 
            background: var(--bg-gradient); 
            background-attachment: fixed;
            color: #333; 
            padding-bottom: 90px; 
            min-height: 100vh;
        }

        /* Pantallas de Carga/Login con fondo inmersivo */
        .full-screen-bg { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%); 
            display: flex; flex-direction: column; justify-content: center; align-items: center; 
            z-index: 1000; color: white; 
        }

        .caja-central { 
            background: rgba(255, 255, 255, 0.95); 
            padding: 40px 30px; 
            border-radius: 20px; 
            width: 85%; max-width: 350px; 
            text-align: center; 
            color: #333; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.3); 
            backdrop-filter: blur(10px);
        }

        h1 { margin: 0 0 10px 0; font-weight: 600; color: #1e3c72; }
        h2 { margin-top: 0; color: #333; }

        /* Botones Mejorados */
        .btn-grande { 
            background: linear-gradient(90deg, #4a90e2, #007bff); 
            color: white; padding: 14px; width: 100%; 
            border: none; border-radius: 12px; 
            font-size: 16px; font-weight: 600; 
            cursor: pointer; margin-top: 15px; 
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(74, 144, 226, 0.4);
        }
        .btn-grande:active { transform: scale(0.98); }

        .btn-curso { 
            width: 100%; padding: 18px; margin-bottom: 12px; 
            background: white; border: none; 
            border-radius: 15px; font-weight: 600; color: #444;
            cursor: pointer; text-align: left; 
            display: flex; align-items: center; 
            box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            transition: all 0.2s;
        }
        .btn-curso:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.1); color: #007bff; }
        .btn-curso span { font-size: 20px; margin-right: 15px; }

        .container { padding: 20px; max-width: 600px; margin: 0 auto; display: none; }
        .seccion { display: none; animation: fadeIn 0.4s; }
        .seccion.activa { display: block; }

        /* Header de Usuario */
        .user-header {
            background: var(--card-bg); padding: 20px; 
            border-radius: 15px; margin-bottom: 25px; 
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: var(--shadow);
        }
        .saldo-badge {
            background: linear-gradient(135deg, #d4fc79 0%, #96e6a1 100%);
            color: #2e7d32; padding: 8px 15px; 
            border-radius: 20px; font-weight: bold;
            box-shadow: 0 2px 10px rgba(150, 230, 161, 0.4);
        }

        /* Tarjetas de Men√∫ Principal */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .menu-card {
            background: white; padding: 25px 15px; 
            border-radius: 15px; text-align: center; 
            cursor: pointer; box-shadow: var(--shadow);
            transition: transform 0.2s;
            font-weight: 600; color: #555;
        }
        .menu-card:active { transform: scale(0.95); }
        .menu-icon { font-size: 30px; display: block; margin-bottom: 10px; }

        /* Lista de Alumnos */
        .tarjeta-alumno { 
            background: white; padding: 18px; 
            margin-bottom: 12px; border-radius: 12px; 
            display: flex; justify-content: space-between; align-items: center; 
            cursor: pointer; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: transform 0.1s; 
        }
        .tarjeta-alumno:active { transform: scale(0.98); background: #f8f9fa; }
        .tarjeta-alumno b { font-size: 15px; color: #333; }

        /* Perfil */
        .perfil-card { 
            background: white; padding: 30px; 
            border-radius: 20px; text-align: center; 
            box-shadow: var(--shadow); position: relative;
        }
        .emoji-perfil { 
            font-size: 80px; margin-bottom: 10px; display: block; 
            background: #f0f2f5; width: 120px; height: 120px; 
            line-height: 120px; border-radius: 50%; margin: 0 auto 20px;
        }
        .dato-perfil { border-bottom: 1px solid #f0f0f0; padding: 15px 0; text-align: left; }
        .dato-perfil strong { color: #888; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; }
        .dato-perfil span { display: block; font-size: 18px; color: #333; font-weight: 500; margin-top: 5px; }

        /* Inputs y Selects */
        input, select { 
            width: 100%; padding: 15px; margin: 10px 0; 
            border: 2px solid #eee; border-radius: 12px; 
            box-sizing: border-box; font-size: 16px; outline: none;
            background: #f9f9f9; transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: #4a90e2; background: white; }

        /* Navbar Inferior */
        nav { 
            background: white; position: fixed; bottom: 0; width: 100%; 
            display: none; justify-content: space-around; padding: 15px 0; 
            z-index: 500; box-shadow: 0 -5px 20px rgba(0,0,0,0.05);
            border-top-left-radius: 20px; border-top-right-radius: 20px;
        }
        nav button { 
            background: none; border: none; color: #ccc; 
            font-size: 26px; cursor: pointer; flex-grow: 1; transition: color 0.3s;
        }
        nav button.active-nav { color: #4a90e2; transform: translateY(-3px); }

        /* Admin Styles */
        .panel-admin { 
            background: white; padding: 20px; border-radius: 15px; 
            border-left: 5px solid #ffc107; margin-top: 40px; display: none; 
            box-shadow: var(--shadow);
        }
        .sub-panel { background: #fffcf0; padding: 15px; border-radius: 10px; margin-top: 15px; border: 1px solid #ffeeba; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="pantalla-cursos" class="full-screen-bg">
        <div class="caja-central">
            <h1>‚òÅÔ∏è VodCoins</h1>
            <p style="color: #666; margin-bottom: 25px;">CSCJ - Econom√≠a Escolar</p>
            <div id="lista-botones-cursos">
                <button class="btn-curso" onclick="seleccionarCurso('curso_1mb')">
                    <span>üìò</span> I¬∫ Medio B
                </button>
                <button class="btn-curso" onclick="seleccionarCurso('curso_limites')">
                    <span>üìà</span> L√≠mites y Derivadas
                </button>
                <button class="btn-curso" onclick="seleccionarCurso('curso_4m')">
                    <span>üéì</span> IV¬∫ Matem√°tica (S.V.)
                </button>
            </div>
        </div>
    </div>

    <div id="pantalla-login" class="full-screen-bg" style="display: none;">
        <div class="caja-central">
            <button onclick="location.reload()" style="background:none; border:none; cursor:pointer; font-size:14px; color:#666;">‚Üê Volver atr√°s</button>
            <h2 id="titulo-login" style="margin-top:10px;">Login</h2>
            
            <select id="login-selector"><option>Conectando...</option></select>
            
            <input type="password" id="login-pin" placeholder="TU CLAVE" style="text-align:center; font-size:20px; text-transform:uppercase; letter-spacing: 2px;">
            <button class="btn-grande" onclick="intentarLogin()">Ingresar</button>
            <p id="error-login" style="color:#e74c3c; font-weight:bold; margin-top:15px; font-size:13px;"></p>
        </div>
    </div>

    <div class="container" id="app-container">
        <div class="user-header">
            <div>
                <span style="font-size:12px; color:#888; text-transform:uppercase; letter-spacing:1px;">Bienvenido,</span><br>
                <strong id="lbl-nombre" style="font-size:18px;">Usuario</strong>
            </div>
            <div class="saldo-badge">
                üí∞ <span id="lbl-saldo">-</span>
            </div>
        </div>

        <div id="inicio" class="seccion activa">
            <h2 style="margin-bottom:20px;">Panel de Control</h2>
            <div class="menu-grid">
                <div class="menu-card" onclick="navegar('lista')">
                    <span class="menu-icon">üë•</span>
                    Ver Curso
                </div>
                <div class="menu-card" onclick="navegar('transferencias')">
                    <span class="menu-icon">üí∏</span>
                    Transferir
                </div>
            </div>
            
            <button class="btn-grande" style="background: linear-gradient(90deg, #ff6b6b, #ee5253); margin-top:30px; box-shadow: 0 4px 15px rgba(238, 82, 83, 0.4);" onclick="location.reload()">üîí Cerrar Sesi√≥n</button>

            <div id="zona-profe" class="panel-admin">
                <h3 style="margin-top:0; color:#d35400;">üîß Profe Admin</h3>
                
                <div class="sub-panel">
                    <p style="font-size:12px; margin:5px 0"><b>Inicializar Curso:</b></p>
                    <button onclick="inicializarBaseDatosNube()" style="background:#2ecc71; color:white; padding:10px; border:none; border-radius:8px; width:100%; font-weight:bold;">üöÄ Resetear / Crear DB</button>
                </div>

                <div class="sub-panel">
                    <strong>üë∂ Nuevo Alumno:</strong>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="nuevo-nombre" placeholder="Nombre" style="margin:0">
                        <button onclick="agregarAlumnoNube()" style="background:#3498db; color:white; border:none; border-radius:8px; width:50px; font-size:20px;">+</button>
                    </div>
                </div>

                <div class="sub-panel">
                    <strong>üö´ Eliminar:</strong>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <select id="sel-eliminar" style="margin:0"></select>
                        <button onclick="eliminarAlumnoNube()" style="background:#e74c3c; color:white; border:none; border-radius:8px; width:50px; font-size:16px;">‚úï</button>
                    </div>
                </div>

                <div class="sub-panel" style="background: #e8f4f8; border-color: #b3e5fc;">
                    <strong>üìä Reportes:</strong>
                    <button onclick="descargarExcelNube()" style="background: #00bcd4; color: white; border: none; padding: 10px; border-radius: 8px; cursor: pointer; width: 100%; margin-top:5px; font-weight:bold;">üì• Descargar Excel</button>
                </div>

                <div class="sub-panel" style="background:#f0f0f0; border:none;">
                    <button onclick="mostrarClaves()" style="background:#95a5a6; color:white; padding:10px; border:none; border-radius:8px; width:100%;">üîë Ver Claves</button>
                </div>
            </div>
        </div>

        <div id="lista" class="seccion">
            <h2 style="margin-bottom:10px;">Compa√±eros</h2>
            <p style="color:#999; font-size:13px; margin-bottom:20px;">Toca un nombre para ver detalles.</p>
            <div id="contenedor-lista">Cargando...</div>
        </div>

        <div id="perfil" class="seccion">
            <button class="btn-volver-atras" onclick="navegar('lista')">‚Üê Volver a la lista</button>
            <div class="perfil-card">
                <span class="emoji-perfil">üéì</span>
                <h2 id="p-nombre" style="margin:0; color:#1e3c72;">Nombre</h2>
                <p id="p-curso" style="color:#999; margin-top:5px;">Curso</p>
                
                <div style="margin: 30px 0;">
                    <span style="font-size:14px; color:#aaa; text-transform:uppercase; letter-spacing:1px;">Saldo Disponible</span>
                    <div id="p-saldo" style="color:#2ecc71; font-size:42px; font-weight:800; text-shadow: 0 5px 15px rgba(46, 204, 113, 0.3);">$0</div>
                </div>
                
                <div class="dato-perfil">
                    <strong>Cumplea√±os</strong>
                    <span id="p-cumple">No registrado</span>
                </div>

                <div class="dato-perfil" style="border:none;">
                    <strong>ID Estudiante</strong> 
                    <span id="p-id">0</span>
                </div>
            </div>
        </div>

        <div id="transferencias" class="seccion">
            <h2>Enviar Monedas</h2>
            <div style="background:white; padding:25px; border-radius:20px; box-shadow:var(--shadow);">
                <label style="font-weight:600; color:#555;">¬øA qui√©n?</label>
                <select id="select-destino"></select>
                
                <label style="font-weight:600; color:#555; margin-top:15px; display:block;">¬øCu√°nto?</label>
                <input type="number" id="monto" placeholder="Ej: 500" style="font-size:24px; font-weight:bold; color:#333;">
                
                <button type="button" class="btn-grande" onclick="realizarTransferencia()">Confirmar Env√≠o</button>
            </div>
        </div>
    </div>

    <nav id="menu-inferior">
        <button onclick="navegar('inicio')" id="nav-inicio" class="active-nav">üè†</button>
        <button onclick="navegar('lista')" id="nav-lista">üë•</button>
        <button onclick="navegar('transferencias')" id="nav-transf">üí∏</button>
    </nav>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, getDoc, getDocs, addDoc, runTransaction, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIGURACI√ìN (Tu misma config)
        const firebaseConfig = {
          apiKey: "AIzaSyB-WmhXSQWbDz8CoRI4LJ7RtFGOeOz_ZQU",
          authDomain: "vodcoins-clase.firebaseapp.com",
          projectId: "vodcoins-clase",
          storageBucket: "vodcoins-clase.firebasestorage.app",
          messagingSenderId: "305176031472",
          appId: "1:305176031472:web:727cd3497c44bc835a9235"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        let cursoID = null;
        let nombreCursoDisplay = ""; 
        let historialID = null;
        let estudiantes = [];
        let usuarioLogueado = null;

        // DATOS BASE (Tus datos)
        const DATA_BASE = {
            "curso_1mb": [ { id: 1, nombre: "Alumno Ejemplo 1M", saldo: 0, cumpleanos: "-" } ],
            "curso_limites": [
                { id: 1, nombre: "Vicente San Martin", saldo: 0, cumpleanos: "-" },
                { id: 2, nombre: "Javiera Lillo", saldo: 0, cumpleanos: "-" },
                { id: 3, nombre: "Ignacio Torres", saldo: 0, cumpleanos: "-" },
                { id: 4, nombre: "Marco Rios", saldo: 0, cumpleanos: "-" },
                { id: 5, nombre: "Gabriela Lillo", saldo: 0, cumpleanos: "-" },
                { id: 6, nombre: "Daniel Lavandero", saldo: 0, cumpleanos: "-" },
                { id: 7, nombre: "Darynka G√≥mez", saldo: 0, cumpleanos: "-" },
                { id: 8, nombre: "Agust√≠n Salgado", saldo: 0, cumpleanos: "-" },
                { id: 9, nombre: "Maximiliano Fuentealba", saldo: 0, cumpleanos: "-" },
                { id: 10, nombre: "Martina Silva", saldo: 0, cumpleanos: "-" },
                { id: 11, nombre: "Leyan Alonso", saldo: 0, cumpleanos: "-" },
                { id: 12, nombre: "Magdalena Aranda", saldo: 0, cumpleanos: "-" },
                { id: 13, nombre: "Alonso Vargas", saldo: 0, cumpleanos: "-" },
                { id: 14, nombre: "Mariapaz Bascour", saldo: 0, cumpleanos: "-" },
                { id: 15, nombre: "Felipe Uribe", saldo: 0, cumpleanos: "-" },
                { id: 16, nombre: "Santiago L√≥pez", saldo: 0, cumpleanos: "-" },
                { id: 17, nombre: "Vicente Fern√°ndez", saldo: 0, cumpleanos: "-" },
                { id: 18, nombre: "Antonella Figueroa", saldo: 0, cumpleanos: "-" },
                { id: 19, nombre: "Lucas Cort√©s", saldo: 0, cumpleanos: "-" },
                { id: 20, nombre: "Samuel Campos", saldo: 0, cumpleanos: "-" },
                { id: 21, nombre: "Nicolas Castro", saldo: 0, cumpleanos: "-" },
                { id: 22, nombre: "Tom√°s Ram√≠rez", saldo: 0, cumpleanos: "-" },
                { id: 23, nombre: "Josefa Mu√±oz", saldo: 0, cumpleanos: "-" },
                { id: 24, nombre: "Tom√°s Arias", saldo: 0, cumpleanos: "-" },
                { id: 25, nombre: "Ricardo Contreras", saldo: 0, cumpleanos: "-" },
                { id: 26, nombre: "Mart√≠n Horn", saldo: 0, cumpleanos: "-" },
                { id: 27, nombre: "Vicente Mu√±oz", saldo: 0, cumpleanos: "-" },
                { id: 28, nombre: "Agustin Gonzalez", saldo: 0, cumpleanos: "-" },
                { id: 29, nombre: "Ian Aguilera", saldo: 0, cumpleanos: "-" },
                { id: 30, nombre: "P√≠a Olave", saldo: 0, cumpleanos: "-" },
                { id: 31, nombre: "Giuliana Anselmi", saldo: 0, cumpleanos: "-" },
                { id: 32, nombre: "Joaquin Navarro", saldo: 0, cumpleanos: "-" },
                { id: 33, nombre: "Juan Vidal", saldo: 0, cumpleanos: "-" },
                { id: 34, nombre: "Vicente Vera", saldo: 0, cumpleanos: "-" },
                { id: 35, nombre: "Amanda Valeria", saldo: 0, cumpleanos: "-" },
                { id: 36, nombre: "Joaqu√≠n Verdugo", saldo: 0, cumpleanos: "-" },
                { id: 37, nombre: "Emilia Silva", saldo: 0, cumpleanos: "-" },
                { id: 38, nombre: "Jose Arriagada", saldo: 0, cumpleanos: "-" }
            ],
            "curso_4m": [ { id: 1, nombre: "Alumno Ejemplo 4M", saldo: 0, cumpleanos: "-" } ]
        };

        const NOMBRES_BONITOS = {
            "curso_1mb": "I¬∫ Medio B",
            "curso_limites": "L√≠mites y derivadas",
            "curso_4m": "IV¬∫ Matem√°tica (S.V.)"
        };

        // --- WINDOW FUNCTIONS ---
        window.seleccionarCurso = (id) => {
            cursoID = id;
            nombreCursoDisplay = NOMBRES_BONITOS[id];
            historialID = "historial_" + id; 
            document.getElementById('pantalla-cursos').style.display = 'none';
            document.getElementById('pantalla-login').style.display = 'flex';
            document.getElementById('titulo-login').textContent = nombreCursoDisplay;
            conectarBaseDatos(id);
        };

        window.intentarLogin = () => {
            const sel = document.getElementById('login-selector');
            const pin = document.getElementById('login-pin').value.toUpperCase();
            const idUser = sel.value;

            if(!idUser) { document.getElementById('error-login').textContent = "‚ö†Ô∏è Selecciona un usuario"; return; }

            if(idUser === 'profe') {
                if (pin === 'ADMIN1') {
                    usuarioLogueado = { id: 'banco', nombre: 'Profesor', saldo: '‚àû', esProfe: true };
                    entrar();
                } else { document.getElementById('error-login').textContent = "‚ùå Clave incorrecta"; }
                return;
            }

            const alumno = estudiantes.find(e => e.id == idUser);
            if(alumno && alumno.pin === pin) {
                usuarioLogueado = { ...alumno, esProfe: false };
                entrar();
            } else { document.getElementById('error-login').textContent = "‚ùå Clave incorrecta"; }
        };

        function entrar() {
            document.getElementById('pantalla-login').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('menu-inferior').style.display = 'flex';
            if(usuarioLogueado.esProfe) {
                document.getElementById('zona-profe').style.display = 'block';
                cargarSelectorEliminar();
            }
            actualizarUI();
        }

        window.navegar = (seccion) => {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.getElementById(seccion).classList.add('activa');
            
            // Highlight Icono Menu
            document.querySelectorAll('nav button').forEach(b => b.classList.remove('active-nav'));
            if(seccion == 'inicio') document.getElementById('nav-inicio').classList.add('active-nav');
            if(seccion == 'lista') document.getElementById('nav-lista').classList.add('active-nav');
            if(seccion == 'transferencias') document.getElementById('nav-transf').classList.add('active-nav');
        }

        // --- FIREBASE ---
        function conectarBaseDatos(colName) {
            const selector = document.getElementById('login-selector');
            selector.innerHTML = '<option>Cargando datos...</option>';
            const q = query(collection(db, colName));
            onSnapshot(q, (snapshot) => {
                estudiantes = [];
                snapshot.forEach((doc) => { estudiantes.push(doc.data()); });
                llenarSelectores(); 
                if(usuarioLogueado) actualizarUI(); 
            });
        }

        function llenarSelectores() {
            const sel = document.getElementById('login-selector');
            sel.innerHTML = '<option value="">-- Selecciona tu nombre --</option><option value="profe">üë®‚Äçüè´ Profesor (Admin)</option>';
            if(estudiantes.length === 0) {
                 let op = document.createElement('option');
                 op.text = "‚ö† (Base vac√≠a - Entra como Profe)"; op.disabled = true; sel.add(op);
            }
            estudiantes.sort((a,b) => a.nombre.localeCompare(b.nombre));
            estudiantes.forEach(est => {
                let op = document.createElement('option');
                op.value = est.id; op.text = est.nombre; sel.add(op);
            });
            if(usuarioLogueado && usuarioLogueado.esProfe) cargarSelectorEliminar();
        }

        function cargarSelectorEliminar() {
            const sel = document.getElementById('sel-eliminar');
            sel.innerHTML = '<option value="">...</option>';
            estudiantes.forEach(est => {
                let op = document.createElement('option');
                op.value = est.id; op.text = est.nombre; sel.add(op);
            });
        }

        window.verPerfil = (id) => {
            const alumno = estudiantes.find(e => e.id == id);
            if(!alumno) return;
            document.getElementById('p-nombre').textContent = alumno.nombre;
            document.getElementById('p-curso').textContent = nombreCursoDisplay;
            document.getElementById('p-saldo').textContent = "$" + alumno.saldo;
            document.getElementById('p-cumple').textContent = alumno.cumpleanos || "-";
            document.getElementById('p-id').textContent = alumno.id;
            navegar('perfil');
        };

        window.realizarTransferencia = async () => {
            const destinoId = document.getElementById('select-destino').value;
            const monto = parseInt(document.getElementById('monto').value);

            if(!destinoId || isNaN(monto)) return alert("Faltan datos");
            if(!usuarioLogueado.esProfe && monto <= 0) return alert("‚õî Solo el Profesor puede restar dinero.");
            if(monto === 0) return alert("El monto no puede ser 0");

            const destinoRef = doc(db, cursoID, destinoId.toString());
            
            try {
                let nombreOrigen = usuarioLogueado.nombre;
                let nombreDestino = "";

                if(usuarioLogueado.esProfe) {
                    const dDoc = await getDoc(destinoRef);
                    nombreDestino = dDoc.data().nombre;
                    await updateDoc(destinoRef, { saldo: dDoc.data().saldo + monto });
                } else {
                    const origenRef = doc(db, cursoID, usuarioLogueado.id.toString());
                    await runTransaction(db, async (transaction) => {
                        const oDoc = await transaction.get(origenRef);
                        const dDoc = await transaction.get(destinoRef);
                        if(oDoc.data().saldo < monto) throw "Saldo insuficiente";
                        nombreDestino = dDoc.data().nombre;
                        transaction.update(origenRef, { saldo: oDoc.data().saldo - monto });
                        transaction.update(destinoRef, { saldo: dDoc.data().saldo + monto });
                    });
                }

                await addDoc(collection(db, historialID), {
                    fecha: new Date().toLocaleDateString(),
                    hora: new Date().toLocaleTimeString(),
                    origen: nombreOrigen,
                    destino: nombreDestino,
                    monto: monto,
                    timestamp: new Date()
                });

                alert(`‚úÖ Transferencia realizada`);
                document.getElementById('monto').value = '';

            } catch (e) {
                alert("‚ùå Error: " + e);
            }
        };

        // ADMIN
        window.agregarAlumnoNube = async () => {
            const nombre = document.getElementById('nuevo-nombre').value;
            const cumple = ""; // Simplificado para admin rapido
            if(!nombre) return;
            let nuevoID = 1;
            if(estudiantes.length > 0) nuevoID = Math.max(...estudiantes.map(e => parseInt(e.id))) + 1;
            const nuevoAlumno = {
                id: nuevoID, nombre: nombre, saldo: 0, cumpleanos: "-",
                pin: Math.random().toString(36).substring(2,8).toUpperCase()
            };
            await setDoc(doc(db, cursoID, nuevoID.toString()), nuevoAlumno);
            alert(`‚úÖ Creado. Clave: ${nuevoAlumno.pin}`);
            document.getElementById('nuevo-nombre').value = '';
        };

        window.eliminarAlumnoNube = async () => {
            const id = document.getElementById('sel-eliminar').value;
            if(!id) return;
            if(confirm("¬øEliminar alumno?")) {
                await deleteDoc(doc(db, cursoID, id.toString()));
                alert("üóëÔ∏è Eliminado");
            }
        };

        window.descargarExcelNube = async () => {
            const q = query(collection(db, historialID), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            csvContent += `REPORTE: ${nombreCursoDisplay}\nID,Nombre,Saldo\n`;
            estudiantes.forEach(e => { csvContent += `${e.id},${e.nombre},${e.saldo}\n`; });
            csvContent += "\n--- HISTORIAL ---\nFecha,Hora,Origen,Destino,Monto\n";
            querySnapshot.forEach((doc) => {
                const h = doc.data();
                csvContent += `${h.fecha},${h.hora},${h.origen},${h.destino},${h.monto}\n`;
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Reporte_${cursoID}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.inicializarBaseDatosNube = async () => {
            if(!confirm("‚ö†Ô∏è ¬øResetear Base de Datos?")) return;
            const lista = DATA_BASE[cursoID];
            for(let est of lista) {
                if(!est.pin) est.pin = Math.random().toString(36).substring(2,8).toUpperCase();
                await setDoc(doc(db, cursoID, est.id.toString()), est);
            }
            alert("‚úÖ Listo.");
        };

        window.mostrarClaves = () => {
            let txt = `CLAVES: ${nombreCursoDisplay}\n----------------\n`;
            estudiantes.forEach(e => txt += `${e.nombre}: ${e.pin}\n`);
            alert(txt);
        };

        function actualizarUI() {
            if(!usuarioLogueado) return;
            
            // Header
            document.getElementById('lbl-nombre').textContent = usuarioLogueado.nombre;
            if(!usuarioLogueado.esProfe) {
                const yo = estudiantes.find(e => e.id == usuarioLogueado.id);
                if(yo) document.getElementById('lbl-saldo').textContent = "$" + yo.saldo;
            } else { document.getElementById('lbl-saldo').textContent = "‚àû"; }

            // Lista con Estilo Nuevo
            const divLista = document.getElementById('contenedor-lista');
            divLista.innerHTML = '';
            estudiantes.forEach(est => {
                divLista.innerHTML += `
                <div class="tarjeta-alumno" onclick="verPerfil('${est.id}')">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <div style="background:#eef; width:35px; height:35px; border-radius:50%; display:flex; justify-content:center; align-items:center; color:#555;">üë§</div>
                        <b>${est.nombre}</b> 
                    </div>
                    <span style="color:#2e7d32; font-weight:bold; background:#e8f5e9; padding:5px 10px; border-radius:15px; font-size:14px;">$${est.saldo}</span>
                </div>`;
            });

            // Selector Destino
            const selDest = document.getElementById('select-destino');
            selDest.innerHTML = '';
            estudiantes.forEach(est => {
                if(usuarioLogueado.id != est.id) {
                     let op = document.createElement('option');
                     op.value = est.id; op.text = est.nombre; selDest.add(op);
                }
            });
        }
    </script>
</body>
</html>
