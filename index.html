<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>VodCoins Cloud V14</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        /* --- ESTILOS GENERALES --- */
        body { font-family: 'Segoe UI', sans-serif; margin: 0; background: #f0f2f5; color: #333; padding-bottom: 80px; }
        .full-screen-bg { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #0f2027, #2c5364); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 1000; color: white; }
        .caja-central { background: white; padding: 30px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; color: #333; box-shadow: 0 10px 25px rgba(0,0,0,0.5); }
        .btn-grande { background: #007bff; color: white; padding: 12px; width: 100%; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin-top: 15px; }
        .btn-curso { width: 100%; padding: 15px; margin-bottom: 10px; background: #f8f9fa; border: 2px solid #ddd; border-radius: 10px; font-weight: bold; cursor: pointer; text-align: left; display: flex; align-items: center; }
        .btn-curso:hover { background: #e2e6ea; }
        .container { padding: 20px; max-width: 600px; margin: 0 auto; display: none; }
        .seccion { display: none; animation: fadeIn 0.4s; }
        .seccion.activa { display: block; }
        .tarjeta-alumno { background: white; padding: 15px; margin-bottom: 10px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }
        input, select { width: 100%; padding: 12px; margin: 8px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; }
        nav { background: #333; position: fixed; bottom: 0; width: 100%; display: none; justify-content: space-around; padding: 10px 0; z-index: 500; }
        nav button { background: none; border: none; color: white; font-size: 24px; cursor: pointer; flex-grow: 1; }
        
        /* Estilos Admin */
        .panel-admin { background: white; padding: 20px; border-radius: 10px; border-left: 5px solid #007bff; margin-top: 40px; display: none; }
        .sub-panel { background: #f8f9fa; padding: 10px; border-radius: 5px; margin-top: 10px; border: 1px solid #eee; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="pantalla-cursos" class="full-screen-bg">
        <div class="caja-central">
            <h1>â˜ï¸ VodCoins Online</h1>
            <p style="color: #666;">Sistema en la Nube</p>
            <div id="lista-botones-cursos">
                <button class="btn-curso" onclick="seleccionarCurso('curso_8b')">ğŸ 8Âº BÃ¡sico</button>
                <button class="btn-curso" onclick="seleccionarCurso('curso_limites')">ğŸ“ˆ LÃ­mites y Derivadas</button>
                <button class="btn-curso" onclick="seleccionarCurso('curso_4to')">ğŸ“ 4Âº MatemÃ¡tica (S.V.)</button>
            </div>
        </div>
    </div>

    <div id="pantalla-login" class="full-screen-bg" style="display: none;">
        <div class="caja-central">
            <button onclick="location.reload()" style="background:none; border:none; cursor:pointer;">â† Volver</button>
            <h2 id="titulo-login">Login</h2>
            <select id="login-selector"><option>Conectando a Google...</option></select>
            <input type="password" id="login-pin" placeholder="CLAVE" style="text-align:center; font-size:20px; text-transform:uppercase;">
            <button class="btn-grande" onclick="intentarLogin()">Entrar</button>
            <p id="error-login" style="color:red; font-weight:bold; margin-top:10px; font-size:12px;"></p>
        </div>
    </div>

    <div class="container" id="app-container">
        <div style="background: white; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center;">
            <div>Hola, <strong id="lbl-nombre">Usuario</strong></div>
            <div style="background: #eef; padding: 5px 10px; border-radius: 15px;">ğŸ’° <strong id="lbl-saldo">-</strong></div>
        </div>

        <div id="inicio" class="seccion activa">
            <h2 style="text-align:center">Panel de Control</h2>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                <div style="background:white; padding:20px; border-radius:10px; text-align:center" onclick="navegar('lista')">ğŸ‘¥ Ver Curso</div>
                <div style="background:white; padding:20px; border-radius:10px; text-align:center" onclick="navegar('transferencias')">ğŸ’¸ Transferir</div>
            </div>
            <button class="btn-grande" style="background:#dc3545; margin-top:30px" onclick="location.reload()">ğŸ”’ Salir</button>

            <div id="zona-profe" class="panel-admin">
                <h3 style="margin-top:0;">ğŸ”§ AdministraciÃ³n Nube</h3>
                
                <div class="sub-panel">
                    <p style="font-size:12px; margin:5px 0">Si el curso estÃ¡ vacÃ­o, pulsa aquÃ­:</p>
                    <button onclick="inicializarBaseDatosNube()" style="background:#28a745; color:white; padding:8px; border:none; border-radius:5px; width:100%;">ğŸš€ Crear Base de Datos</button>
                </div>

                <div class="sub-panel">
                    <strong>ğŸ‘¶ Nuevo Alumno:</strong>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <input type="text" id="nuevo-nombre" placeholder="Nombre" style="margin:0">
                        <input type="text" id="nuevo-cumple" placeholder="Cumple" style="margin:0; width:80px;">
                        <button onclick="agregarAlumnoNube()" style="background:#007bff; color:white; border:none; border-radius:5px; width:40px;">+</button>
                    </div>
                </div>

                <div class="sub-panel">
                    <strong>ğŸš« Eliminar:</strong>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <select id="sel-eliminar" style="margin:0"></select>
                        <button onclick="eliminarAlumnoNube()" style="background:#dc3545; color:white; border:none; border-radius:5px; width:40px;">X</button>
                    </div>
                </div>

                <div class="sub-panel" style="background: #d1ecf1; border-color: #bee5eb;">
                    <strong>ğŸ“Š Excel:</strong>
                    <button onclick="descargarExcelNube()" style="background: #117a8b; color: white; border: none; padding: 10px; border-radius: 5px; cursor: pointer; width: 100%; margin-top:5px;">ğŸ“¥ Descargar Reporte Completo</button>
                </div>

                <div class="sub-panel">
                    <button onclick="mostrarClaves()" style="background:#6c757d; color:white; padding:8px; border:none; border-radius:5px; width:100%;">ğŸ”‘ Ver Claves</button>
                </div>
            </div>
        </div>

        <div id="lista" class="seccion">
            <h2>Curso en Vivo</h2>
            <div id="contenedor-lista">Cargando...</div>
        </div>

        <div id="transferencias" class="seccion">
            <h2>Realizar Transferencia</h2>
            <form style="background:white; padding:20px; border-radius:10px;">
                <label>Para:</label>
                <select id="select-destino"></select>
                <label>Monto:</label>
                <input type="number" id="monto" placeholder="0">
                <button type="button" class="btn-grande" onclick="realizarTransferencia()">Enviar</button>
            </form>
        </div>
    </div>

    <nav id="menu-inferior">
        <button onclick="navegar('inicio')">ğŸ </button>
        <button onclick="navegar('lista')">ğŸ‘¥</button>
        <button onclick="navegar('transferencias')">ğŸ’¸</button>
    </nav>

    <script type="module">
        // 1. IMPORTAR LIBRERÃAS DE GOOGLE
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, updateDoc, deleteDoc, onSnapshot, getDoc, getDocs, addDoc, runTransaction, query, orderBy } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // 2. TU CONFIGURACIÃ“N (YA INTEGRADA)
        const firebaseConfig = {
          apiKey: "AIzaSyB-WmhXSQWbDz8CoRI4LJ7RtFGOeOz_ZQU",
          authDomain: "vodcoins-clase.firebaseapp.com",
          projectId: "vodcoins-clase",
          storageBucket: "vodcoins-clase.firebasestorage.app",
          messagingSenderId: "305176031472",
          appId: "1:305176031472:web:727cd3497c44bc835a9235"
        };

        // INICIAR
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // VARIABLES GLOBALES
        let cursoID = null;
        let historialID = null;
        let estudiantes = [];
        let usuarioLogueado = null;

        // DATOS BASE (Solo para inicializar)
        const DATA_BASE = {
            "curso_8b": [
                { id: 1, nombre: "Alumno 8B Uno", saldo: 200, cumpleanos: "1 Enero" },
                { id: 2, nombre: "Alumno 8B Dos", saldo: 200, cumpleanos: "2 Febrero" }
            ],
            "curso_limites": [ { id: 1, nombre: "Estudiante Limite 1", saldo: 500, cumpleanos: "-" } ],
            "curso_4to": [ { id: 1, nombre: "Santi Vodanovic 1", saldo: 1000, cumpleanos: "-" } ]
        };

        // --- FUNCIONES WINDOW ---
        window.seleccionarCurso = (id) => {
            cursoID = id;
            historialID = "historial_" + id; // ColecciÃ³n separada para historial
            document.getElementById('pantalla-cursos').style.display = 'none';
            document.getElementById('pantalla-login').style.display = 'flex';
            document.getElementById('titulo-login').textContent = id.replace('curso_', 'Clase: ').toUpperCase();
            conectarBaseDatos(id);
        };

        window.intentarLogin = () => {
            const sel = document.getElementById('login-selector');
            const pin = document.getElementById('login-pin').value.toUpperCase();
            const idUser = sel.value;

            if(idUser === 'profe' && pin === 'ADMIN1') {
                usuarioLogueado = { id: 'banco', nombre: 'Profesor', saldo: 'âˆ', esProfe: true };
                entrar();
                return;
            }

            const alumno = estudiantes.find(e => e.id == idUser);
            if(alumno && alumno.pin === pin) {
                usuarioLogueado = { ...alumno, esProfe: false };
                entrar();
            } else {
                document.getElementById('error-login').textContent = "âŒ Clave incorrecta";
            }
        };

        function entrar() {
            document.getElementById('pantalla-login').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            document.getElementById('menu-inferior').style.display = 'flex';
            
            if(usuarioLogueado.esProfe) {
                document.getElementById('zona-profe').style.display = 'block';
                cargarSelectorEliminar();
            }
            actualizarUI();
        }

        window.navegar = (seccion) => {
            document.querySelectorAll('.seccion').forEach(s => s.classList.remove('activa'));
            document.getElementById(seccion).classList.add('activa');
        }

        // --- FIREBASE LOGIC ---
        function conectarBaseDatos(colName) {
            const selector = document.getElementById('login-selector');
            selector.innerHTML = '<option>Cargando datos...</option>';

            // Escuchar cambios en vivo
            const q = query(collection(db, colName));
            onSnapshot(q, (snapshot) => {
                estudiantes = [];
                snapshot.forEach((doc) => {
                    estudiantes.push(doc.data());
                });
                
                if(estudiantes.length === 0) {
                    selector.innerHTML = '<option value="">âš  Base vacÃ­a (Entra como profe)</option>';
                } else {
                    llenarSelectores();
                }
                
                if(usuarioLogueado) actualizarUI(); // Refrescar pantalla si ya estoy dentro
            });
        }

        function llenarSelectores() {
            const sel = document.getElementById('login-selector');
            sel.innerHTML = '<option value="">-- Soy... --</option><option value="profe">ğŸ‘¨â€ğŸ« Profesor</option>';
            estudiantes.sort((a,b) => a.nombre.localeCompare(b.nombre));
            estudiantes.forEach(est => {
                let op = document.createElement('option');
                op.value = est.id; op.text = est.nombre; sel.add(op);
            });
            if(usuarioLogueado && usuarioLogueado.esProfe) cargarSelectorEliminar();
        }

        function cargarSelectorEliminar() {
            const sel = document.getElementById('sel-eliminar');
            sel.innerHTML = '<option value="">...</option>';
            estudiantes.forEach(est => {
                let op = document.createElement('option');
                op.value = est.id; op.text = est.nombre; sel.add(op);
            });
        }

        // TRANSFERENCIA ATÃ“MICA + HISTORIAL
        window.realizarTransferencia = async () => {
            const destinoId = document.getElementById('select-destino').value;
            const monto = parseInt(document.getElementById('monto').value);

            if(!destinoId || isNaN(monto) || monto <= 0) return alert("Datos invÃ¡lidos");

            const destinoRef = doc(db, cursoID, destinoId.toString());
            
            try {
                let nombreOrigen = usuarioLogueado.nombre;
                let nombreDestino = "";

                if(usuarioLogueado.esProfe) {
                    // Profe suma
                    const dDoc = await getDoc(destinoRef);
                    nombreDestino = dDoc.data().nombre;
                    await updateDoc(destinoRef, { saldo: dDoc.data().saldo + monto });
                } else {
                    // Alumno transfiere
                    const origenRef = doc(db, cursoID, usuarioLogueado.id.toString());
                    
                    await runTransaction(db, async (transaction) => {
                        const oDoc = await transaction.get(origenRef);
                        const dDoc = await transaction.get(destinoRef);

                        if(oDoc.data().saldo < monto) throw "Saldo insuficiente";

                        nombreDestino = dDoc.data().nombre;

                        transaction.update(origenRef, { saldo: oDoc.data().saldo - monto });
                        transaction.update(destinoRef, { saldo: dDoc.data().saldo + monto });
                    });
                }

                // GUARDAR EN HISTORIAL (NUEVO)
                await addDoc(collection(db, historialID), {
                    fecha: new Date().toLocaleDateString(),
                    hora: new Date().toLocaleTimeString(),
                    origen: nombreOrigen,
                    destino: nombreDestino,
                    monto: monto,
                    timestamp: new Date()
                });

                alert("âœ… Transferencia Exitosa");
                document.getElementById('monto').value = '';

            } catch (e) {
                alert("âŒ Error: " + e);
            }
        };

        // ADMIN: AGREGAR ALUMNO
        window.agregarAlumnoNube = async () => {
            const nombre = document.getElementById('nuevo-nombre').value;
            const cumple = document.getElementById('nuevo-cumple').value;
            if(!nombre) return;

            // Calcular ID nuevo
            let nuevoID = 1;
            if(estudiantes.length > 0) nuevoID = Math.max(...estudiantes.map(e => parseInt(e.id))) + 1;

            const nuevoAlumno = {
                id: nuevoID,
                nombre: nombre,
                saldo: 0,
                cumpleanos: cumple || "-",
                pin: Math.random().toString(36).substring(2,8).toUpperCase()
            };

            await setDoc(doc(db, cursoID, nuevoID.toString()), nuevoAlumno);
            alert(`âœ… Creado. Clave: ${nuevoAlumno.pin}`);
            document.getElementById('nuevo-nombre').value = '';
        };

        // ADMIN: ELIMINAR ALUMNO
        window.eliminarAlumnoNube = async () => {
            const id = document.getElementById('sel-eliminar').value;
            if(!id) return;
            if(confirm("Â¿Eliminar alumno?")) {
                await deleteDoc(doc(db, cursoID, id.toString()));
                alert("ğŸ—‘ï¸ Eliminado");
            }
        };

        // ADMIN: DESCARGAR EXCEL COMPLETO
        window.descargarExcelNube = async () => {
            // 1. Obtener Historial de la nube
            const q = query(collection(db, historialID), orderBy("timestamp", "desc"));
            const querySnapshot = await getDocs(q);
            
            let csvContent = "data:text/csv;charset=utf-8,\uFEFF";
            
            // SecciÃ³n Saldos
            csvContent += `REPORTE: ${cursoID.toUpperCase()}\n`;
            csvContent += "ID,Nombre,Saldo,Cumple\n";
            estudiantes.forEach(e => {
                csvContent += `${e.id},${e.nombre},${e.saldo},${e.cumpleanos}\n`;
            });

            // SecciÃ³n Historial
            csvContent += "\n--- HISTORIAL DE MOVIMIENTOS ---\n";
            csvContent += "Fecha,Hora,Origen,Destino,Monto\n";
            
            querySnapshot.forEach((doc) => {
                const h = doc.data();
                csvContent += `${h.fecha},${h.hora},${h.origen},${h.destino},${h.monto}\n`;
            });

            // Descargar
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Reporte_${cursoID}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        window.inicializarBaseDatosNube = async () => {
            if(!confirm("Â¿Crear base de datos inicial?")) return;
            const lista = DATA_BASE[cursoID];
            for(let est of lista) {
                if(!est.pin) est.pin = Math.random().toString(36).substring(2,8).toUpperCase();
                await setDoc(doc(db, cursoID, est.id.toString()), est);
            }
            alert("Base creada.");
        };

        window.mostrarClaves = () => {
            let txt = "";
            estudiantes.forEach(e => txt += `${e.nombre}: ${e.pin}\n`);
            alert(txt);
        };

        // UI UPDATE
        function actualizarUI() {
            if(!usuarioLogueado) return;
            
            if(!usuarioLogueado.esProfe) {
                const yo = estudiantes.find(e => e.id == usuarioLogueado.id);
                if(yo) document.getElementById('lbl-saldo').textContent = "$" + yo.saldo;
            } else {
                document.getElementById('lbl-saldo').textContent = "âˆ";
            }
            document.getElementById('lbl-nombre').textContent = usuarioLogueado.nombre;

            // Render lista
            const divLista = document.getElementById('contenedor-lista');
            divLista.innerHTML = '';
            estudiantes.forEach(est => {
                divLista.innerHTML += `<div class="tarjeta-alumno"><b>${est.nombre}</b> <span>$${est.saldo}</span></div>`;
            });

            // Render Select Destino
            const selDest = document.getElementById('select-destino');
            selDest.innerHTML = '';
            estudiantes.forEach(est => {
                if(usuarioLogueado.id != est.id) {
                     let op = document.createElement('option');
                     op.value = est.id; op.text = est.nombre; selDest.add(op);
                }
            });
        }
    </script>
</body>
</html>
